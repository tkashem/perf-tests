{{$namespaces := 100}}
{{$deploymentsPerNamespace := 60}}
{{$concurrentDeploymentWorkers := 100}}
{{$concurrentObjectWorkers := 200}}
{{$objects := 500}}

name: Simple Test
automanagedNamespaces: {{$namespaces}}
deleteStaleNamespaces: true
deleteAutomanagedNamespaces: false
tuningSets:
  - name: Sequence
    parallelismLimitedLoad:
      parallelismLimit: 1
  - name: DeploymentConcurrency
    parallelismLimitedLoad:
      parallelismLimit: {{$concurrentDeploymentWorkers}}
  - name: ObjectConcurrency
    parallelismLimitedLoad:
      parallelismLimit: {{$concurrentObjectWorkers}}
steps:
- name: Starting measurement for waiting for pods
  measurements:
  - Identifier: WaitForRunningDeployments
    Method: WaitForControlledPodsRunning
    Params:
      action: start
      apiVersion: apps/v1
      kind: Deployment
      labelSelector: group = load
      operationTimeout: 15m
- name: Creating Deployment and Objects
  phases:
    - namespaceRange:
        min: 1
        max: {{$namespaces}}
      replicasPerNamespace: {{$deploymentsPerNamespace}}
      tuningSet: DeploymentConcurrency
      objectBundle:
      - basename: small-service
        objectTemplatePath: deployment/service.yaml
      - basename: small-deployment
        objectTemplatePath: deployment/configmap.yaml
      - basename: small-deployment
        objectTemplatePath: deployment/secret.yaml
      - basename: small-deployment
        objectTemplatePath: deployment/deployment.yaml
        templateFillMap:
          ReplicasMin: 1
          ReplicasMax: 1
          SvcName: small-service
    - namespaceRange:
        min: 1
        max: {{$namespaces}}
      replicasPerNamespace: {{$objects}}
      tuningSet: ObjectConcurrency
      objectBundle:
      - basename: dummy-secret
        objectTemplatePath: secret.yaml
      - basename: dummy-configmap
        objectTemplatePath: configmap.yaml
- name: Waiting for pods to be running
  measurements:
  - Identifier: WaitForRunningDeployments
    Method: WaitForControlledPodsRunning
    Params:
      action: gather
- name: Deleting Deployments
  phases:
  - namespaceRange:
      min: 1
      max: {{$namespaces}}
    replicasPerNamespace: 0
    tuningSet: DeploymentConcurrency
    objectBundle:
      - basename: small-deployment
        objectTemplatePath: deployment/configmap.yaml
      - basename: small-deployment
        objectTemplatePath: deployment/secret.yaml
      - basename: small-deployment
        objectTemplatePath: deployment/deployment.yaml
      - basename: small-service
        objectTemplatePath: deployment/service.yaml
  - namespaceRange:
      min: 1
      max: {{$namespaces}}
    replicasPerNamespace: 0
    tuningSet: ObjectConcurrency
    objectBundle:
    - basename: dummy-secret
      objectTemplatePath: secret.yaml
    - basename: dummy-configmap
      objectTemplatePath: configmap.yaml
- name: Waiting for pods to be deleted
  measurements:
  - Identifier: WaitForRunningDeployments
    Method: WaitForControlledPodsRunning
    Params:
      action: gather
